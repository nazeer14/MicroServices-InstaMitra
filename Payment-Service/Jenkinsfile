pipeline {
    agent any

    environment {
        REGISTRY = "docker.io/nazeer14/payment-service"  // Change to your DockerHub/Registry
        SERVICE_NAME = "${env.JOB_NAME}"      // Jenkins Job name = service name
        IMAGE_TAG = "${env.BUILD_NUMBER}"     // Use build number as tag
    }

    tools {
        jdk "jdk17"         // Pre-configure in Jenkins Global Tools
        maven "maven3"      // Pre-configure in Jenkins Global Tools
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean install -DskipTests'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build("${REGISTRY}/${SERVICE_NAME}:${IMAGE_TAG}")
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') {
                        dockerImage.push()
                        dockerImage.push("latest")
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                echo "Deploy step for ${SERVICE_NAME} (optional - k8s/compose)"
                // For Kubernetes:
                // sh "kubectl rollout restart deployment ${SERVICE_NAME} -n your-namespace"
            }
        }
    }

    post {
        success {
            echo "✅ Build & Deploy successful for ${SERVICE_NAME}"
        }
        failure {
            echo "❌ Build failed for ${SERVICE_NAME}"
        }
    }
}
